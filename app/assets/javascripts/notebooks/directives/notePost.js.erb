'use strict';

angular.module('notebookApp').directive('notePost', [
  '$sce',
  function($sce){
    return{
      restrict: 'E',
      templateUrl: "<%= asset_path('notebooks/templates/directives/notePost.html') %>",
      scope:{
        note: '=',
        setFocus: '=',
        removeNoteFromArray: '='
      },
      link: function(scope, element, attrs){
        scope.bod = $sce.trustAsHtml(scope.note.body);

        scope.setElementOffset = function(){
          element.offset(
            {
              left: parseInt(scope.note.hstore.x) + parseInt(box.left),
              top: parseInt(scope.note.hstore.y) + parseInt(box.top)
            }
          )
        }

        var box = element[0].getBoundingClientRect();
        element.css('width', ('' + scope.note.hstore.width + 'px'));
        element.css('position', 'absolute');
        scope.setElementOffset();

        element.on('dragend', function(e){
          console.log(e)
          scope.note.hstore.x = parseInt(scope.note.hstore.x) + parseInt(e.originalEvent.offsetX);
          scope.note.hstore.y = parseInt(scope.note.hstore.y) + parseInt(e.originalEvent.offsetY) - parseInt(element.height());

          scope.setElementOffset();
          scope.note.$save();
        })

        var bodyContainer = element.find('.body-container');

        if(scope.note.body == ''){
          bodyContainer.focus();
        }

        bodyContainer.on('input', function(){
          if (scope.note.id){
            scope.note.body = bodyContainer.html();
            scope.note.$save();
          }
        })

        bodyContainer.on('blur', function(){
          if(scope.note.body == ''){
            scope.removeNote();
          }
        })


        scope.removeNote = function($event){
          if($event){$event.stopImmediatePropagation()}

          scope.removeNoteFromArray(scope.note);
          element.remove();
          scope.note.$delete();
        }

        scope.toggleTopBar = function(){
          scope.showTopBar = !scope.showTopBar;
        }
      }
    }
  }
]);
